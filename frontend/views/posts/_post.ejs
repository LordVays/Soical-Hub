<div class="post-card" id="post-<%= post._id %>">
    <div class="post-header">
        <img src="<%= post.author && post.author.profileAvatar ? post.author.profileAvatar : '/images/default-avatar.jpg' %>" alt="Avatar" class="post-avatar">

        <div>
            <span class="post-author-name">
                <a href="/profile/<%= post.userId %>">
                    <%= post.author ? post.author.username : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' %>
                </a>
            </span>
        </div>
        <span class="post-timestamp"><%= new Date(post.createdAt).toLocaleString('ru-RU') %></span>
    </div>

    <div class="post-content">
        <p><%= post.desc %></p>

        <% if (post.img) { %>
            <img src="<%= post.img %>" alt="Post image" class="post-image">
        <% } %>
    </div>

    <div class="post-actions">
        <button class="btn like-btn <%= post.likes.includes(currentUser._id.toString()) ? 'liked' : '' %>" data-post-id="<%= post._id %>">
            <% if (post.likes.includes(currentUser._id.toString())) { %>
                ‚ù§Ô∏è <span class="like-count"><%= post.likes.length %></span>
            <% } else { %>
                ü§ç <span class="like-count"><%= post.likes.length %></span>
            <% } %>
        </button>

        <button class="btn comment-toggle-btn" data-post-id="<%= post._id %>">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (<%= post.comments ? post.comments.length : 0 %>)</button>

        <% if (currentUser && currentUser._id.toString() === post.userId.toString()) { %>
            <!-- <button class="btn edit-post-btn" data-post-id="<%= post._id %>">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button> -->
            <button class="btn btn-danger delete-post-btn" data-post-id="<%= post._id %>">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        <% } %>
    </div>

    <div class="comments-section" id="comments-<%= post._id %>" style="display: none;"> <!-- Initially hidden -->
        <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>

        <% if (post.comments && post.comments.length > 0) { %>
            <% post.comments.forEach(comment => { %>
                <div class="comment" id="comment-<%= comment._id %>">
                    <strong class="comment-author">
                        <%# Ideally, fetch comment author's username. For now, use ID or a placeholder %>
                        <%= comment.userId.substring(0, 8) %>...:
                    </strong>
                    <span class="comment-text"><%= comment.text %></span>
                    <small class="text-muted d-block"><%= new Date(comment.createdAt).toLocaleString('ru-RU') %></small>
                    <% if (currentUser && (currentUser._id.toString() === comment.userId.toString() || currentUser._id.toString() === post.userId.toString())) { %>
                        <!-- <button class="btn btn-sm btn-danger delete-comment-btn" data-post-id="<%= post._id %>" data-comment-id="<%= comment._id %>">–£–¥–∞–ª–∏—Ç—å</button> -->
                    <% } %>
                </div>
            <% }) %>
        <% } else { %>
            <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
        <% } %>

        <form class="comment-form mt-2" data-post-id="<%= post._id %>">
            <div class="form-group">
                <textarea name="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="form-control" required></textarea>
            </div>
            
            <button type="submit" class="btn btn-secondary btn-sm submit-comment-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const commentToggleBtns = document.querySelectorAll('.comment-toggle-btn');
    commentToggleBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const postId = btn.dataset.postId;
            const commentsSection = document.getElementById(`comments-${postId}`);
            if (commentsSection) {
                commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
            }
        });
    });
});
</script>